<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <title>STT Demo</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 600px;
            margin: 80px auto;
            text-align: center;
        }

        #stato {
            font-size: 1.4em;
            margin: 20px 0;
            color: #555;
        }

        #risultato {
            font-size: 1.2em;
            margin: 20px 0;
            min-height: 40px;
            color: #222;
        }

        #risposta {
            color: #1a73e8;
        }

        button {
            font-size: 1em;
            padding: 12px 28px;
            cursor: pointer;
            border-radius: 8px;
            border: none;
            background: #1a73e8;
            color: white;
        }

        button:disabled {
            background: #aaa;
        }

        .ascolto {
            color: #e53935;
        }
    </style>
</head>

<body>
    <h1>Voice Assistant</h1>

    <div id="stato">Premi il bottone per iniziare</div>
    <div id="risultato"></div>
    <div id="risposta"></div>
    <br>
    <button id="btn" onclick="avvia()">Inizia ascolto</button>
    <button id="btn-pausa">&#9725; Stop</button>
    <button id="btn-riprendi">&#9654; Play</button>

    <script>

        document.getElementById("btn-pausa").onclick = () => {
            window.speechSynthesis.pause();
        };

        document.getElementById("btn-riprendi").onclick = () => {
            window.speechSynthesis.resume();
        };

        let recognition;

        function avvia() {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                alert("Usa Chrome o Edge!");
                return;
            }
            window.speechSynthesis.cancel();
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = "it-IT";
            recognition.continuous = false;
            recognition.interimResults = false;

            document.getElementById("btn").disabled = true;

            recognition.onresult = (event) => {
                const testo = event.results[0][0].transcript.toLowerCase();
                document.getElementById("risultato").textContent = `Sentito: "${testo}"`;
                console.log(`Sentito: "${testo}"`);
                mandaComando(testo);
            };

            recognition.onend = () => {
                // Qui è sicuro richiamare start(), il recognition è definitivamente fermo
                document.getElementById("btn").disabled = false;
            };

            recognition.onerror = (e) => {
                setStato(`Errore: ${e.error}`, false);
                document.getElementById("btn").disabled = false;
            };

            recognition.start();
        }

        async function mandaComando(testo) {
            console.log("mandaComando", testo)
            setStato("Elaborazione...", false);
            const res = await fetch("/comando", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ testo })
            });
            const data = await res.json();
            document.getElementById("risposta").textContent = data.risposta;

            parla(data.risposta);

            setStato("Premi il bottone per un nuovo comando", false);
            document.getElementById("btn").disabled = false;
        }

        function setStato(msg, ascolto) {
            const el = document.getElementById("stato");
            el.textContent = msg;
            el.className = ascolto ? "ascolto" : "";
        }

        function parla(testo) {
            const utterance = new SpeechSynthesisUtterance(testo);
            utterance.lang = "it-IT";
            utterance.rate = 1.3;   // velocità (0.5 - 2)
            utterance.pitch = 1.0;  // tono (0 - 2)
            utterance.volume = 1.0; // volume (0 - 1)
            window.speechSynthesis.speak(utterance);
        }
    </script>
</body>

</html>